import pandas as pd
import os
import json
import tkinter as tk
from tkinter import filedialog

# Create a Tkinter root window and hide it
root = tk.Tk()
root.withdraw()

# Ask the user to select the Excel file
excel_file = filedialog.askopenfilename(
    title="Select Excel File",
    filetypes=[("Excel Files", "*.xlsx *.xls")]
)
if not excel_file:
    print("No file selected. Exiting.")
    exit()

# Read the selected Excel file
df = pd.read_excel(excel_file)

# Group rows by 'Tab name'
tabs = {}
dashboard_data_by_tab = {}
for idx, row in df.iterrows():
    tab = row['Tab name']
    tab_id = tab.lower().replace(" ", "_")
    if tab not in tabs:
        tabs[tab] = []
        dashboard_data_by_tab[tab_id] = []
    
    def format_date(dt):
        day = dt.day
        # Handle special case for 11, 12, 13
        if 11 <= day <= 13:
            suffix = 'th'
        else:
            suffix = {1: 'st', 2: 'nd', 3: 'rd'}.get(day % 10, 'th')
        return f"{day}{suffix} {dt.strftime('%B %Y')}"

    # Process DeadlineToGreen:
    deadline = row['DeadlineToGreen']
    if pd.isnull(deadline):
        deadline = "N/A"
    elif isinstance(deadline, pd.Timestamp):
        deadline = format_date(deadline)
    else:
        try:
            temp_dt = pd.to_datetime(deadline)
            deadline = format_date(temp_dt)
        except Exception:
            deadline = str(deadline)
            if deadline.lower() == "nan":
                deadline = "N/A"

    item = {
        "topic": row['Topic'],
        "complianceRating": row['Compliance Rating'],
        "residualRisk": row['Residual Risk'],
        "deadlineToGreen": deadline,
        "controlsComments": row['Comments']
    }
    tabs[tab].append(item)
    dashboard_data_by_tab[tab_id].append(item)

# Build the HTML for tab headers and tab contents
tab_headers_html = ""
tab_contents_html = ""
first_tab = True

for tab, items in tabs.items():
    tab_id = tab.lower().replace(" ", "_")
    active_class = " active" if first_tab else ""
    aria_selected = "true" if first_tab else "false"
    
    # Tab header button
    tab_headers_html += f'''
    <li class="nav-item" role="presentation">
      <button class="nav-link{active_class}" id="{tab_id}-tab" data-bs-toggle="tab" data-bs-target="#{tab_id}" type="button" role="tab" aria-controls="{tab_id}" aria-selected="{aria_selected}">
        {tab}
      </button>
    </li>
    '''
    
    # Updated chart container with two side-by-side charts
    chart_html = f'''
    <div class="row my-4">
      <div class="col-md-6 d-flex flex-column align-items-center">
        <div id="complianceChartContainer_{tab_id}" class="chart-container">
          <canvas id="complianceChart_{tab_id}"></canvas>
        </div>
      </div>
      <div class="col-md-6 d-flex flex-column align-items-center">
        <div id="riskChartContainer_{tab_id}" class="chart-container">
          <canvas id="riskChart_{tab_id}"></canvas>
        </div>
      </div>
    </div>
    '''
    
    # New sort panel with sort controls and a new toggle view button.
    sort_buttons_html = f'''
    <div class="mb-3 text-center">
      <label for="sortCriteria_{tab_id}">Sort by:</label>
      <select id="sortCriteria_{tab_id}" class="form-select d-inline-block w-auto ms-2">
        <option value="compliance">Compliance</option>
        <option value="residualRisk">Residual Risk</option>
      </select>
      <label for="sortOrder_{tab_id}" class="ms-3">Order:</label>
      <select id="sortOrder_{tab_id}" class="form-select d-inline-block w-auto ms-2">
        <option value="asc">Ascending (Red to Green)</option>
        <option value="desc">Descending (Green to Red)</option>
      </select>
      <button class="btn btn-primary ms-3 sortBtn" data-tab="{tab_id}">Sort</button>
      <button class="btn btn-secondary ms-3 toggleViewBtn" data-tab="{tab_id}">Toggle Table View</button>
    </div>
    '''
    
    # Build cards container HTML; note we add an additional container for table view.
    cards_html = ""
    for item in items:
        cards_html += f'''
        <div class="col-md-3">
          <div class="card hse-card">
            <div class="card-header">{item['topic']}</div>
            <div class="card-body">
              <div class="score-badges">
                <span class="badge-custom">{item['complianceRating']}</span>
                <span class="badge-custom">{item['residualRisk']}</span>
              </div>
              <p class="mb-1"><strong>Deadline to Green:</strong></p>
              <div class="deadline-date">&#x1F4C5; {item['deadlineToGreen']}</div>
              <div class="details-section" style="display:none;">
                <hr>
                <p><strong>Controls/Comments:</strong><br>{item['controlsComments']}</p>
              </div>
              <div class="click-indicator">&#x25BC;</div>
            </div>
          </div>
        </div>
        '''
    
    active_tab_class = " show active" if first_tab else ""
    tab_contents_html += f'''
    <div class="tab-pane fade{active_tab_class}" id="{tab_id}" role="tabpanel" aria-labelledby="{tab_id}-tab">
      {chart_html}
      {sort_buttons_html}
      <div id="cardsContainer_{tab_id}" class="row">
        {cards_html}
      </div>
      <div id="tableContainer_{tab_id}" style="display:none;"></div>
    </div>
    '''
    
    first_tab = False

# Convert dashboard data to JSON for JavaScript
dashboard_data_json = json.dumps(dashboard_data_by_tab)

# Updated HTML template with the requested changes embedded.
html_template = f'''<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Health & Safety Dashboard</title>
  
  <!-- Bootstrap CSS for layout & styling -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    body {{
      margin: 20px;
      background-color: #f9f9f9;
      font-family: sans-serif;
      transition: background-color 0.3s ease, color 0.3s ease;
    }}
    .badge-custom {{
      display: inline-block;
      padding: 0.5em 1em;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.85em;
      min-width: 120px;
      text-align: center;
      margin: 0.25rem;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }}
    .comp-green, .risk-green {{
      background-color: #00B894; 
      color: #fff;
    }}
    .comp-amber, .risk-amber {{
      background-color: #FDB338;
      color: #000;
    }}
    .comp-red, .risk-red {{
      background-color: #FF6B6B;
      color: #fff;
    }}
    .comp-unknown, .risk-unknown {{
      background-color: #A8B2C1;
      color: #fff;
    }}
    .hse-card {{
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      margin-bottom: 20px;
    }}
    .hse-card:hover {{
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }}
    .card {{
      display: flex;
      flex-direction: column;
      border: none;
    }}
    .card-header {{
      font-weight: bold;
      text-align: center;
      height: 50px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      background-color: #e9ecef;
    }}
    .card-body {{
      text-align: center;
      flex-grow: 1;
    }}
    .details-section {{
      margin-top: 10px;
    }}
    .nav-tabs .nav-link {{
      font-size: 1.1em;
      font-weight: bold;
    }}
    .click-indicator {{
      text-align: center; 
      font-size: 1.4em; 
      color: #999; 
      margin-top: 10px;
    }}
    /* Key styling */
    .dashboard-key {{
      max-width: 600px;
      margin: 30px auto;
    }}
    /* Chart container styling */
    .chart-container {{
      height: 400px;
      width: 100%;
      max-width: 500px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin: 10px;
    }}
    /* New styles for Deadline and Scores */
    .deadline-date {{
      font-size: 0.9em;
      background-color: #e7f1ff;
      color: #084298;
      padding: 5px 10px;
      border-radius: 5px;
      display: inline-block;
    }}
    .score-badges {{
      margin-bottom: 10px;
    }}
    /* Dark mode styles */
    body.dark-mode {{
      background-color: #343a40;
      color: #f8f9fa;
    }}
    body.dark-mode .card {{
      background-color: #495057;
      color: #f8f9fa;
    }}
    body.dark-mode .card-header {{
      background-color: #6c757d;
    }}
    body.dark-mode .badge-custom {{
      background-color: #adb5bd;
      color: #343a40;
    }}
    body.dark-mode .nav-tabs .nav-link {{
      background-color: #495057;
      border-color: #6c757d;
      color: #f8f9fa;
    }}
    body.dark-mode .nav-tabs .nav-link.active {{
      background-color: #6c757d;
      border-color: #adb5bd;
    }}
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center">
    <h1 class="my-4">University of Nottingham: Health &amp; Safety Dashboard</h1>
    <img src="https://www.nottingham.ac.uk/Brand/LegacyAssets/images-multimedia/2022/Logos/BrandEvolution-NottinghamBlue-Cropped-450x173.png" 
        alt="University of Nottingham Logo" 
        style="max-height: 120px;">
  </div>


  <!-- Tabbed interface -->
  <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
    {tab_headers_html}
  </ul>

  <div class="tab-content" id="dashboardTabsContent">
    {tab_contents_html}
  </div>
  
  <!-- Dashboard Key moved to bottom -->
  <div class="dashboard-key">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title text-center">Key</h5>
        <p class="card-text text-center">Below is a quick guide to the Residual Risk/Assurance levels:</p>
        <table class="table table-bordered">
          <tbody>
            <tr>
              <th style="background-color: #28a745; color: #fff; width: 100px;">Full Assurance/Low Risk</th>
              <td>Fully evidenced, adequate documentation; low likelihood of a serious incident.</td>
            </tr>
            <tr>
              <th style="background-color: #ffc107; color: #000;">Partial Assurance/Moderate Risk</th>
              <td>Evidence of some documentation; moderate likelihood of a serious incident.</td>
            </tr>
            <tr>
              <th style="background-color: #dc3545; color: #fff;">No Assurance/Immediate Risk</th>
              <td>No evidence of controls; high likelihood of a serious incident.</td>
            </tr>
            <tr>
              <th style="background-color: #6c757d; color: #fff;">Unknown Assurance</th>
              <td>Insufficient information to make a reliable assessment.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
</div>

<!-- Bootstrap Bundle JS (includes Popper for tabs) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Global dashboard data grouped by tab (generated from Excel)
  const dashboardDataByTab = {dashboard_data_json};
  // Global objects to store chart instances per tab
  const riskCharts = {{}};
  const complianceCharts = {{}};
  // Global object to track view mode per tab ("cards" or "table")
  const viewMode = {{}};

  // Helper function to return the appropriate badge class
  function getBadgeClass(rating, type) {{
    let r = rating.toLowerCase();
    if (r === "green") {{
      return type === "compliance" ? "badge-custom comp-green" : "badge-custom risk-green";
    }} else if (r === "amber") {{
      return type === "compliance" ? "badge-custom comp-amber" : "badge-custom risk-amber";
    }} else if (r === "red") {{
      return type === "compliance" ? "badge-custom comp-red" : "badge-custom risk-red";
    }} else {{
      return type === "compliance" ? "badge-custom comp-unknown" : "badge-custom risk-unknown";
    }}
  }}

  // New helper functions for text labels
  function getComplianceText(rating) {{
    let r = rating.toLowerCase();
    if (r === "green") {{
      return "Full Compliance";
    }} else if (r === "amber") {{
      return "Partial Compliance";
    }} else if (r === "red") {{
      return "No Compliance";
    }} else {{
      return "Unknown Compliance";
    }}
  }}

  function getRiskText(rating) {{
    let r = rating.toLowerCase();
    if (r === "green") {{
      return "Low Risk";
    }} else if (r === "amber") {{
      return "Moderate Risk";
    }} else if (r === "red") {{
      return "Immediate Risk";
    }} else {{
      return "Unknown Risk";
    }}
  }}

  // Build cards for a given tab into its container
  function buildCards(tabId, dataArray) {{
    const container = document.getElementById("cardsContainer_" + tabId);
    let html = "";
    dataArray.forEach(item => {{
      let compClass = getBadgeClass(item.complianceRating, "compliance");
      let riskClass = getBadgeClass(item.residualRisk, "risk");
      html += `
        <div class="col-md-3">
          <div class="card hse-card">
            <div class="card-header">${{item.topic}}</div>
            <div class="card-body">
              <div class="score-badges">
                <span class="${{compClass}}">${{getComplianceText(item.complianceRating)}}</span>
                <span class="${{riskClass}}">${{getRiskText(item.residualRisk)}}</span>
              </div>
              <p class="mb-1"><strong>Deadline to Green:</strong></p>
              <div class="deadline-date">&#x1F4C5; ${{item.deadlineToGreen}}</div>
              <div class="details-section" style="display:none;">
                <hr>
                <p><strong>Controls/Comments:</strong><br>${{item.controlsComments}}</p>
              </div>
              <div class="click-indicator">&#x25BC;</div>
            </div>
          </div>
        </div>
      `;
    }});
    container.innerHTML = html;

    // Add click toggling for card details
    container.querySelectorAll('.hse-card').forEach(card => {{
      card.addEventListener('click', function() {{
        const details = this.querySelector('.details-section');
        details.style.display = details.style.display === 'block' ? 'none' : 'block';
      }});
    }});
  }}

  // Build table view for a given tab into its container.
  // Build table view for a given tab into its container.
  function buildTable(tabId, dataArray) {{
    const container = document.getElementById("tableContainer_" + tabId);
    let html = `<table class="table table-striped table-bordered">
       <thead>
          <tr>
            <th style="width:25%; cursor:pointer;" onclick="sortTableByColumn('{tab_id}', 'topic', this)">Title</th>
            <th style="width:25%; cursor:pointer;" onclick="sortTableByColumn('{tab_id}', 'compliance', this)">Compliance Score</th>
            <th style="width:25%; cursor:pointer;" onclick="sortTableByColumn('{tab_id}', 'risk', this)">Risk Score</th>
            <th style="width:25%; cursor:pointer;" onclick="sortTableByColumn('{tab_id}', 'deadline', this)">Deadline to Green</th>
          </tr>
       </thead>
       <tbody>`;
    dataArray.forEach((item, index) => {{
         html += `<tr class="table-row" data-index="${{index}}" style="cursor: pointer;">
            <td>${{item.topic}}</td>
            <td>
              <span class="${{getBadgeClass(item.complianceRating, 'compliance')}}">
                ${{getComplianceText(item.complianceRating)}}
              </span>
            </td>
            <td>
              <span class="${{getBadgeClass(item.residualRisk, 'risk')}}">
                ${{getRiskText(item.residualRisk)}}
              </span>
            </td>
            <td>
              <div class="deadline-date">&#x1F4C5; ${{item.deadlineToGreen}}</div>
            </td>
         </tr>
         <tr class="detail-row" style="display: none;">
             <td colspan="4">
                 <strong>Controls/Comments:</strong> ${{item.controlsComments}}
             </td>
         </tr>`;
    }});
    html += `</tbody></table>`;
    container.innerHTML = html;
    // Add event listener to toggle detail rows when a row is clicked.
    container.querySelectorAll('.table-row').forEach(row => {{
       row.addEventListener('click', function() {{
            const detailRow = this.nextElementSibling;
            detailRow.style.display = detailRow.style.display === 'table-row' ? 'none' : 'table-row';
       }});
    }});
  }}

  // Build the Residual Risk pie chart for a given tab with updated labels
  function buildRiskChartForTab(tabId, dataArray) {{
    const canvasId = 'riskChart_' + tabId;
    const canvasElem = document.getElementById(canvasId);
    if (!canvasElem) return;
    const ctx = canvasElem.getContext('2d');

    if (riskCharts[tabId]) {{
      riskCharts[tabId].destroy();
    }}

    const riskCounts = {{ "Green": 0, "Amber": 0, "Red": 0, "Unknown": 0 }};
    dataArray.forEach(item => {{
      const r = item.residualRisk;
      if (riskCounts.hasOwnProperty(r)) {{
        riskCounts[r]++;
      }} else {{
        riskCounts["Unknown"]++;
      }}
    }});

    riskCharts[tabId] = new Chart(ctx, {{
      type: 'doughnut',
      data: {{
        labels: ['Full Assurance/Low Risk', 'Partial Assurance/Moderate Risk', 'No Assurance/Immediate Risk', 'Unknown Assurance'],
        datasets: [ {{
          data: [riskCounts["Green"], riskCounts["Amber"], riskCounts["Red"], riskCounts["Unknown"]],
          backgroundColor: [
            'rgba(40, 167, 69, 0.8)',
            'rgba(255, 193, 7, 0.8)',
            'rgba(220, 53, 69, 0.8)',
            'rgba(108, 117, 125, 0.8)'
          ],
          borderColor: [
            'rgb(40, 167, 69)',
            'rgb(255, 193, 7)',
            'rgb(220, 53, 69)',
            'rgb(108, 117, 125)'
          ],
          borderWidth: 2,
          hoverBorderWidth: 3,
          hoverBorderColor: [
            'rgb(25, 135, 84)',
            'rgb(225, 163, 0)',
            'rgb(190, 33, 49)',
            'rgb(88, 97, 105)'
          ],
          hoverOffset: 10
        }} ]
      }},
      options: {{
        responsive: true,
        maintainAspectRatio: false,
        cutout: '65%',
        plugins: {{
          legend: {{
            position: 'bottom',
            labels: {{
              padding: 20,
              usePointStyle: true,
              pointStyle: 'circle',
              font: {{
                size: 12,
                family: "'Helvetica Neue', 'Helvetica', 'Arial', sans-serif"
              }}
            }}
          }},
          title: {{
            display: true,
            text: 'Residual Risk Distribution',
            font: {{
              size: 16,
              weight: 'bold',
              family: "'Helvetica Neue', 'Helvetica', 'Arial', sans-serif"
            }},
            padding: {{
              top: 10,
              bottom: 30
            }}
          }},
          tooltip: {{
            callbacks: {{
              label: function(context) {{
                const label = context.label || '';
                const value = context.raw || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return `${{label}}: ${{value}} (${{percentage}}%)`;
              }}
            }},
            padding: 12,
            bodyFont: {{
              size: 14
            }},
            titleFont: {{
              size: 14,
              weight: 'bold'
            }}
          }}
        }},
        animation: {{
          animateScale: true,
          animateRotate: true,
          duration: 1000,
          easing: 'easeInOutQuart'
        }},
onClick: function(evt, activeEls, chart) {{
  if (activeEls.length > 0) {{
    const index = activeEls[0].index;
    const label = chart.data.labels[index];
    const riskMapping = {{
      'Full Assurance/Low Risk': 'Green',
      'Partial Assurance/Moderate Risk': 'Amber',
      'No Assurance/Immediate Risk': 'Red',
      'Unknown Assurance': 'Unknown'
    }};
    const risk = riskMapping[label];
    filterCardsByRisk(tabId, risk);
  }}
}}

      }}
    }});
  }}

  // Build the Compliance pie chart for a given tab with updated labels
  function buildComplianceChartForTab(tabId, dataArray) {{
    const canvasId = 'complianceChart_' + tabId;
    const canvasElem = document.getElementById(canvasId);
    if (!canvasElem) return;
    const ctx = canvasElem.getContext('2d');

    if (complianceCharts[tabId]) {{
      complianceCharts[tabId].destroy();
    }}

    const complianceCounts = {{ "Green": 0, "Amber": 0, "Red": 0, "Unknown": 0 }};
    dataArray.forEach(item => {{
      const c = item.complianceRating;
      if (complianceCounts.hasOwnProperty(c)) {{
        complianceCounts[c]++;
      }} else {{
        complianceCounts["Unknown"]++;
      }}
    }});

    complianceCharts[tabId] = new Chart(ctx, {{
      type: 'doughnut',
      data: {{
        labels: ['Full Assurance/Low Risk', 'Partial Assurance/Moderate Risk', 'No Assurance/Immediate Risk', 'Unknown Assurance'],
        datasets: [ {{
          data: [complianceCounts["Green"], complianceCounts["Amber"], complianceCounts["Red"], complianceCounts["Unknown"]],
          backgroundColor: [
            'rgba(40, 167, 69, 0.8)',
            'rgba(255, 193, 7, 0.8)',
            'rgba(220, 53, 69, 0.8)',
            'rgba(108, 117, 125, 0.8)'
          ],
          borderColor: [
            'rgb(40, 167, 69)',
            'rgb(255, 193, 7)',
            'rgb(220, 53, 69)',
            'rgb(108, 117, 125)'
          ],
          borderWidth: 2,
          hoverBorderWidth: 3,
          hoverBorderColor: [
            'rgb(25, 135, 84)',
            'rgb(225, 163, 0)',
            'rgb(190, 33, 49)',
            'rgb(88, 97, 105)'
          ],
          hoverOffset: 10
        }} ]
      }},
      options: {{
        responsive: true,
        maintainAspectRatio: false,
        cutout: '65%',
        plugins: {{
          legend: {{
            position: 'bottom',
            labels: {{
              padding: 20,
              usePointStyle: true,
              pointStyle: 'circle',
              font: {{
                size: 12,
                family: "'Helvetica Neue', 'Helvetica', 'Arial', sans-serif"
              }}
            }}
          }},
          title: {{
            display: true,
            text: 'Compliance Distribution',
            font: {{
              size: 16,
              weight: 'bold',
              family: "'Helvetica Neue', 'Helvetica', 'Arial', sans-serif"
            }},
            padding: {{
              top: 10,
              bottom: 30
            }}
          }},
          tooltip: {{
            callbacks: {{
              label: function(context) {{
                const label = context.label || '';
                const value = context.raw || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return `${{label}}: ${{value}} (${{percentage}}%)`;
              }}
            }},
            padding: 12,
            bodyFont: {{
              size: 14
            }},
            titleFont: {{
              size: 14,
              weight: 'bold'
            }}
          }}
        }},
        animation: {{
          animateScale: true,
          animateRotate: true,
          duration: 1000,
          easing: 'easeInOutQuart'
        }},
onClick: function(evt, activeEls, chart) {{
  if (activeEls.length > 0) {{
    const index = activeEls[0].index;
    const label = chart.data.labels[index];
    const complianceMapping = {{
      'Full Assurance/Low Risk': 'Green',
      'Partial Assurance/Moderate Risk': 'Amber',
      'No Assurance/Immediate Risk': 'Red',
      'Unknown Assurance': 'Unknown'
    }};
    const compliance = complianceMapping[label];
    filterCardsByCompliance(tabId, compliance);
  }}
}}

      }}
    }});
  }}

  // Filter cards by Residual Risk
  function filterCardsByRisk(tabId, risk) {{
    const allData = dashboardDataByTab[tabId];
    const filtered = allData.filter(item => item.residualRisk === risk);
    // Rebuild based on current view mode
    if(viewMode[tabId] === "table") {{
      buildTable(tabId, filtered);
    }} else {{
      buildCards(tabId, filtered);
    }}
  }}

  // Filter cards by Compliance
  function filterCardsByCompliance(tabId, compliance) {{
    const allData = dashboardDataByTab[tabId];
    const filtered = allData.filter(item => item.complianceRating === compliance);
    if(viewMode[tabId] === "table") {{
      buildTable(tabId, filtered);
    }} else {{
      buildCards(tabId, filtered);
    }}
  }}

  // Sorting order mapping for Compliance
  const complianceOrder = {{
    "unknown": 1,
    "red": 2,
    "amber": 3,
    "green": 4
  }};

  // Sorting order mapping for Residual Risk
  const residualRiskOrder = {{
    "unknown": 1,
    "red": 2,
    "amber": 3,
    "green": 4
  }};

  // Sort cards by Compliance rating for a given tab
  function sortCardsByCompliance(tabId, order) {{
    const data = dashboardDataByTab[tabId].slice();
    data.sort((a, b) => {{
      const aVal = complianceOrder[a.complianceRating.toLowerCase()] || 0;
      const bVal = complianceOrder[b.complianceRating.toLowerCase()] || 0;
      return order === "asc" ? aVal - bVal : bVal - aVal;
    }});
    if(viewMode[tabId] === "table") {{
      buildTable(tabId, data);
    }} else {{
      buildCards(tabId, data);
    }}
  }}

  // Sort cards by Residual Risk for a given tab
  function sortCardsByResidualRisk(tabId, order) {{
    const data = dashboardDataByTab[tabId].slice();
    data.sort((a, b) => {{
      const aVal = residualRiskOrder[a.residualRisk.toLowerCase()] || 0;
      const bVal = residualRiskOrder[b.residualRisk.toLowerCase()] || 0;
      return order === "asc" ? aVal - bVal : bVal - aVal;
    }});
    if(viewMode[tabId] === "table") {{
      buildTable(tabId, data);
    }} else {{
      buildCards(tabId, data);
    }}
  }}

 // Function to sort table by column header click. (Defined in global scope)
function sortTableByColumn(tabId, column, headerElem) {{
  console.log("Sorting table for tab:", tabId, "Column:", column);  // Debug statement
  let currentOrder = headerElem.getAttribute('data-order') || 'asc';
  let newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
  headerElem.setAttribute('data-order', newOrder);
  // Remove data-order attribute from sibling headers.
  headerElem.parentElement.querySelectorAll('th').forEach(th => {{
     if (th !== headerElem) {{
       th.removeAttribute('data-order');
     }}
  }});
  
  // Make a copy of the data array for sorting.
  let data = dashboardDataByTab[tabId].slice();
  data.sort((a, b) => {{
     let aVal, bVal;
     if (column === 'topic') {{
        aVal = a.topic.toLowerCase();
        bVal = b.topic.toLowerCase();
     }} else if (column === 'compliance') {{
        aVal = a.complianceRating.toLowerCase();
        bVal = b.complianceRating.toLowerCase();
     }} else if (column === 'risk') {{
        aVal = a.residualRisk.toLowerCase();
        bVal = b.residualRisk.toLowerCase();
     }} else if (column === 'deadline') {{
        // Helper to parse deadline strings by stripping ordinal suffixes.
        const parseDeadline = (d) => {{
            let dTrim = d.toLowerCase();
            if(dTrim === "n/a") return new Date(0);
            dTrim = dTrim.replace(/(st|nd|rd|th)/g, '');
            return new Date(dTrim);
        }};
        aVal = parseDeadline(a.deadlineToGreen);
        bVal = parseDeadline(b.deadlineToGreen);
        return newOrder === 'asc' ? aVal - bVal : bVal - aVal;
     }}
     if(aVal < bVal) return newOrder === 'asc' ? -1 : 1;
     if(aVal > bVal) return newOrder === 'asc' ? 1 : -1;
     return 0;
  }});
  
  // Optionally update the global data if you want subsequent sorts to use the sorted order:
  // dashboardDataByTab[tabId] = data;
  
  buildTable(tabId, data);
}}



  // Initialize charts, cards, table view, and event listeners for each tab on page load
  document.addEventListener('DOMContentLoaded', function() {{
    for (const tabId in dashboardDataByTab) {{
      // Default view is cards
      viewMode[tabId] = "cards";
      buildCards(tabId, dashboardDataByTab[tabId]);
      buildRiskChartForTab(tabId, dashboardDataByTab[tabId]);
      buildComplianceChartForTab(tabId, dashboardDataByTab[tabId]);

      // Attach sort functionality using the new sort panel
      document.querySelectorAll(`.sortBtn[data-tab="${{tabId}}"]`).forEach(btn => {{
        btn.addEventListener('click', function() {{
          const criteria = document.getElementById(`sortCriteria_${{tabId}}`).value;
          const order = document.getElementById(`sortOrder_${{tabId}}`).value;
          if(criteria === 'compliance') {{
            sortCardsByCompliance(tabId, order);
          }} else {{
            sortCardsByResidualRisk(tabId, order);
          }}
        }});
      }});

      // Attach toggle view functionality
      document.querySelectorAll(`.toggleViewBtn[data-tab="${{tabId}}"]`).forEach(btn => {{
        btn.addEventListener('click', function() {{
          if(viewMode[tabId] === "cards") {{
            viewMode[tabId] = "table";
            // Hide cards container, show table container and build table
            document.getElementById("cardsContainer_" + tabId).style.display = "none";
            document.getElementById("tableContainer_" + tabId).style.display = "block";
            buildTable(tabId, dashboardDataByTab[tabId]);
          }} else {{
            viewMode[tabId] = "cards";
            // Hide table container, show cards container and build cards
            document.getElementById("tableContainer_" + tabId).style.display = "none";
            document.getElementById("cardsContainer_" + tabId).style.display = "flex";
            buildCards(tabId, dashboardDataByTab[tabId]);
          }}
        }});
      }});
    }}

    // Rebuild the charts when a tab is shown to ensure proper rendering.
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tabButton => {{
      tabButton.addEventListener('shown.bs.tab', function (e) {{
        const target = e.target.getAttribute('data-bs-target'); // e.g. "#tab_id"
        const tabId = target.substring(1); // remove '#' to get the id
        setTimeout(() => {{
          buildRiskChartForTab(tabId, dashboardDataByTab[tabId]);
          buildComplianceChartForTab(tabId, dashboardDataByTab[tabId]);
        }}, 100);
      }});
    }});
  }});

  // Dark mode toggle functionality
  document.getElementById('darkModeToggle').addEventListener('click', function() {{
    document.body.classList.toggle('dark-mode');
  }});
</script>

</body>
</html>
'''

# Determine the directory of the current script and set the output file path
script_dir = os.path.dirname(os.path.abspath(__file__))
output_file = os.path.join(script_dir, 'output.html')

with open(output_file, 'w', encoding='utf-8') as f:
    f.write(html_template)

print(f"HTML file generated at: {output_file}")
